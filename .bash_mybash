# term 

# use term command to ssh with tmux terminal
term () {
    if [[ "${1// }" ]]; then 
        TMUX_TERM_NAME="${1}"
    fi
    if [[ -z "${TMUX// }" ]] && [[ $- == *i* ]] && [[ -n "${TMUX_TERM_NAME// }" ]]; then
        ##[[ -z "${TMUX_TERM_NAME// }" ]] && TMUX_TERM_NAME="init"
        tmux has-session -t $TMUX_TERM_NAME &> /dev/null
        if [[ $? -eq 1 ]]; then
            tmux new-session -d -s $TMUX_TERM_NAME \; \
                 new-window -t $TMUX_TERM_NAME:1 "emacsclient -t" \; \
                 swap-window -s $TMUX_TERM_NAME:1 -t $TMUX_TERM_NAME:0
            tmux attach-session -d -t $TMUX_TERM_NAME
        else
            #if [[ -z $(tmux list-clients -t $TMUX_TERM_NAME) ]]; then
            #    tmux attach-session -t $TMUX_TERM_NAME
            #else
            #    echo "Session $TMUX_TERM_NAME has already attached. Exit.."
            #fi
            tmux attach-session -d -t $TMUX_TERM_NAME
        fi
    fi
}

# open file in already open emacsclient in current session
tmux_emacsclient () {
    if [[ -z $TMUX ]]; then 
        emacsclient -t $1
        echo 'Error. Not in TMUX session.'
        return 1
    fi  

    if [[ -n "$1" ]]; then
        target="$1"
    else
        target="."
    fi

    if [[ ! -r "$1" && -n "$1" ]]; then
        echo "${FUNCNAME[0]}: cannot access '$1': No such file or directory"
        return 2
    fi


    found=false
    for i in $(tmux list-panes -s -F "#{pane_pid},#{pane_id}");    
    do
        pane_pid=${i%,*}
        pane_id=${i#*,}
        if [[ "$(pstree $pane_pid)" == *"emacsclient"*  ]]; then            
            found=true
            break
        fi
    done
    
    if $found; then
        path=$([[ -f $target ]] && realpath $target || echo "")
        tmux send-keys -t $pane_id C-g C-g 
        tmux send-keys -t $pane_id C-x C-f $path Enter 
    else 
        tmux new-window emacsclient -t $target
        #tmux split-window -v 
        #tmux resize-pane -y 6
        #tmux select-pane -t 1
        tmux if-shell 'tmux move-window -t 0' '' 'swap-window -t 0'
    fi        
    tmux select-window -t 0;

}

# swap to dedicated emacs-org window. using with tmux shortcut
tmux_show_org () {
    WINDOW_NUM=1322
    SESSION_NAME=ORGLIFE
    ORG_PATH=~/org/
    
    #check if in tmux session
    if [[ -z $TMUX ]]; then return 1; fi

    session_find=$(tmux list-sessions -F '#{session_name}' | grep -i $SESSION_NAME)
    if [[ -z $session_find ]]; then
        #create new session
        #SAVE_TMUX=$TMUX
        #unset TMUX
        env -i tmux new-session -d -s $SESSION_NAME \
             "emacsclient -t $ORG_PATH"
    fi
    
    window_number=$(tmux display-message -p '#I')
    if [[ $window_number == $WINDOW_NUM ]]; then 
        export $(tmux show-environment -g TMUX_CUSTOM_PREVIOUS_WINDOW)
        tmux select-window -t $TMUX_CUSTOM_PREVIOUS_WINDOW
        tmux unlink-window -t $WINDOW_NUM
    else        
        window_find=$(tmux list-windows -F "#{window_index}" | grep -i $WINDOW_NUM)
        if [[ -z $window_find ]]; then
            tmux link-window -d -s $SESSION_NAME:0 -t $WINDOW_NUM
        fi
        last_window=$(tmux display-message -p \
                           '#{window_index}.#{pane_index}')
        tmux set-environment -g TMUX_CUSTOM_PREVIOUS_WINDOW $last_window
        tmux select-window -t $WINDOW_NUM
    fi   
}

tmux_swap_window () {
    set -o xtrace
    # https://stackoverflow.com/questions/806906/how-do-i-test-if-a-variable-is-a-number-in-bash
    ! [[ "$1" =~ ^[0-9]+$ ]] && return 1 

    next_window=$1
    current_window=$(tmux display-message -p '#{window_index}')
    if [[ $current_window == $next_window ]]; then
        export $(tmux show-environment TMUX_CUSTOM_PREVIOUS_SWAP)
        tmux select-window -t :=$TMUX_CUSTOM_PREVIOUS_SWAP
    else
        tmux set-environment TMUX_CUSTOM_PREVIOUS_SWAP $current_window
        tmux select-window -t :=$next_window
    fi
    set +o xtrace
}

tmux_emacs_session() {
    set -o xtrace
    SESSION_NAME=EMACS
    SERVER_NAME=foo

    if [[ -n $TMUX ]]; then return 1; fi
    session_find=$(tmux list-sessions -F '#{session_name}' | grep -i $SESSION_NAME)
    if [[ -z $session_find ]]; then
        #echo "Start emacs server..."
        #emacs --eval "(setq server-name \"$SERVER_NAME\")" --daemon &> /dev/null
        tmux new-session -d -s $SESSION_NAME \
            "emacsclient -t $@"
            #"emacsclient -s $SERVER_NAME -t $@"
    fi    
    tmux attach -t $SESSION_NAME
    set +o xtrace
}

emacs_global() {
    if [[ $# != 1 ]]; then 
        echo "Error: open file more than one is not support yet"
        return 1
    fi
    path=$PWD/$1
    SESSION_NAME=EMACS
    SERVER_NAME=foo

    #set -o xtrace
    session_find=$(tmux list-sessions -F '#{session_name}' | grep -i $SESSION_NAME)
    if [[ -n $session_find ]]; then
        current_command=$(tmux list-panes -t $SESSION_NAME:0 -F "#{pane_index}:#{pane_current_command}" 2>&1 | grep -i emacsclient | head -1)
        if [[ -z $current_command ]]; then
            tmux move-window -a -s $SESSION_NAME:0 -t $SESSION_NAME >/dev/null 2>&1 
            tmux new-window -d -t $SESSION_NAME:0 emacsclient -t "$path"
            pane_index=1
        else
            pane_index=${current_command%:*}
            tmux send-keys -t $SESSION_NAME:0.$pane_index C-g C-g 
            tmux send-keys -t $SESSION_NAME:0.$pane_index C-x C-f "$path" Enter         
        fi
        tmux select-window -t $SESSION_NAME:0
        tmux select-pane -t $SESSION_NAME:0.$pane_index
    fi 
    #set +o xtrace
}
test1() {
    echo $#
}

term

# bash-completion kubectl
type kubectl &> /dev/null && source <(kubectl completion bash)

#alias
alias e='emacs_global'
alias el='emacs_local'
